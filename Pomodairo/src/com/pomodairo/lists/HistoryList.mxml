<?xml version="1.0"?>
<!--
  Created by akalanitski on 07.12.2016.
-->
<s:Group
    xmlns:fx="http://ns.adobe.com/mxml/2009"
    xmlns:s="library://ns.adobe.com/flex/spark"
    xmlns:mx="library://ns.adobe.com/flex/mx"
    creationComplete="init()">

    <fx:Script><![CDATA[
        import com.pomodairo.EmbedImages;
        import com.pomodairo.EmbedStyle;
        import com.pomodairo.TableUtils;
        import com.pomodairo.db.Storage;
        import com.pomodairo.settings.ConfigManager;

        private var configManager:ConfigManager;
        private var db:Storage = Storage.instance;

        private function initDateField(df:DateField):void {
            df.selectedDate = new Date();
        }

        public function copyTableToClipboard(title:String, data:Array):void {
            var tmpString:String = new TableUtils().getTableAsCsv(data);
            System.setClipboard(tmpString);
        }

        private var _timer:Timer;
        private var _lastUpdate:uint; /* ms */
        private var UPDATE_DELAY:Number = 1000; /* ms */

        private function init():void {
            _timer = new Timer(UPDATE_DELAY);
            _timer.addEventListener(TimerEvent.TIMER, timerTickHandler);
            _timer.start();
        }

        private function timerTickHandler(event:TimerEvent):void {
            update();
        }

        private var _needUpdate:Boolean = false;

        private function needUpdate():void
        {
            _needUpdate = true;
            update();
        }

        private function update():void {
            var timePassed:Boolean = getTimer() - _lastUpdate > UPDATE_DELAY;
            if (_needUpdate && timePassed) {
                db.getPomodorosOfDay(dateFieldPomsOfDay.selectedDate, pomodoroRangeStepper.value, pomodoroFilter.text);
                _needUpdate = false;
            }
        }

        ]]>
    </fx:Script>

    <s:BorderContainer height="32" width="100%"
        backgroundColor="{EmbedStyle.SECTION_BACKGROUND_COLOR}"
        borderVisible="false">
        <s:layout>
            <s:HorizontalLayout verticalAlign="middle"/>
        </s:layout>
        <s:Label text="HISTORY"
            color="{EmbedStyle.SECTION_TEXT_COLOR}"
            fontWeight="bold"
            verticalAlign="middle"
            paddingLeft="4"/>
        <s:Spacer width="100%" />
        <s:BitmapImage source="{EmbedImages.ICON_SEARCH}" width="24" height="24"/>
        <s:TextInput id="pomodoroFilter" width="132" height="32" change="{needUpdate()}"
            contentBackgroundAlpha="0"
            color="{EmbedStyle.COMMON_TEXT_COLOR}" />
        <mx:Button width="32" height="32" icon="{EmbedImages.ICON_COPY_CLASS}"
            click="copyTableToClipboard('Pomodoros', db.pomodorosOfDayDataset.source)"/>
    </s:BorderContainer>

    <!-- task list -->
    <s:List id="list"
        dataProvider="{db.pomodorosOfDayDataset}"
        top="32" right="0" bottom="32" left="0"
        contentBackgroundAlpha="0"
        borderVisible="false"
        doubleClickEnabled="true"
        itemRenderer="com.pomodairo.components.PomodoroOfDayRenderer"
        dragMoveEnabled="true" width="100%">
    </s:List>
    <s:HGroup height="32" right="0" bottom="0" left="0">
        <mx:DateField id="dateFieldPomsOfDay" initialize="initDateField(this.dateFieldPomsOfDay)"
            change="{needUpdate()}"/>
        <mx:Label text="Days"/>
        <mx:NumericStepper
            minimum="-365"
            maximum="365"
            stepSize="1"
            id="pomodoroRangeStepper"
            value="0"
            width="50"
            maxChars="4"
            change="{needUpdate()}"/>
    </s:HGroup>
</s:Group>
