<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:fc="http://www.adobe.com/2006/fc"
	xmlns:s="library://ns.adobe.com/flex/spark"
	initialize="init()">

	<mx:Script>
		<![CDATA[
		import com.pomodairo.EmbedImages;
		import com.pomodairo.Pomodoro;
		import com.pomodairo.TableUtils;
		import com.pomodairo.db.Storage;
		import com.pomodairo.settings.ConfigManager;

		import flash.system.System;

		import mx.collections.ArrayCollection;

		private var tabs:ArrayCollection = new ArrayCollection(["History", "Day", "Week"]);
		private var configManager:ConfigManager;
		private var db:Storage = Storage.instance;

		private function init():void {
			configManager = ConfigManager.instance;
			configManager.initialize();
			db.initAndOpenDatabase();
			db.initViews();
			showSelectedPanel();
			//db.getAllItems();
		}

		private function initDateField(df:DateField):void {
			df.selectedDate = new Date();
		}

		private function remove(pom:Pomodoro):void {
			db.remove(pom);
		}

		private function cleanup(event:MouseEvent):void {
			for each (var pom:Pomodoro in db.dataset) {
				if (pom.type == Pomodoro.TYPE_INTERRUPTION) {
					remove(pom);
				} else if (pom.done) {
					remove(pom);
				}
			}
			db.getAllItems();
		}

		private function onPomsPerDayClicked(event:Event):void {
			db.getPomodorosPerDay();
		}

		private function onPomsOfDayClicked(event:Event):void {
			db.getPomodorosOfDay(dateFieldPomsOfDay.selectedDate, pomodoroRangeStepper.value, String(pomodoroFilter.value));
		}

		private function onRealityFactorsClicked(event:Event):void {
			db.getRealityFactors();
		}

		public function copyTableToClipboard(title:String,
											 data:Array):void {
			var tmpString:String = new TableUtils().getTableAsCsv(data);
			System.setClipboard(tmpString);
		}

		private function tabsList_clickHandler(event:MouseEvent):void {
			trace("Selected Item: " + tabsList.selectedIndex);
			if (selectedTab != tabsList.selectedIndex) {
				showSelectedPanel();
			}
		}

		private var selectedTab:int = 0;

		private function showSelectedPanel():void {
			pomodorosOfDayPanel.includeInLayout = pomodorosOfDayPanel.visible = false;
			pomodorosPerDayPanel.includeInLayout = pomodorosPerDayPanel.visible = false;
			realityFactorPanel.includeInLayout = realityFactorPanel.visible = false;
			switch (tabsList.selectedIndex) {
				case 0:
					pomodorosOfDayPanel.includeInLayout = pomodorosOfDayPanel.visible = true;
					break;
				case 1:
					pomodorosPerDayPanel.includeInLayout = pomodorosPerDayPanel.visible = true;
					break;
				case 2:
					realityFactorPanel.includeInLayout = realityFactorPanel.visible = true;
					break;
			}
			selectedTab = tabsList.selectedIndex;
		}
		]]>
	</mx:Script>

	<s:HGroup left="0" top="0" height="32" right="0">
		<s:List id="tabsList"
				height="32"
				dataProvider="{tabs}" selectedIndex="0" click="{tabsList_clickHandler(event)}"
			contentBackgroundAlpha="0" borderVisible="false" color="#adadad"
		lineHeight="32">
			<s:layout >
				<s:HorizontalLayout />
			</s:layout>
		</s:List>
	</s:HGroup>

	<!-- task list -->
	<s:Group id="pomodorosOfDayPanel" left="0" top="32" right="0" bottom="0">
        <s:List id="list"
            dataProvider="{db.pomodorosOfDayDataset}"
            top="0" right="0" bottom="32" left="0"
            contentBackgroundAlpha="0"
            borderVisible="false"
            doubleClickEnabled="true"
            itemRenderer="com.pomodairo.components.PomodoroOfDayRenderer"
            dragMoveEnabled="true" width="100%">
        </s:List>
		<s:HGroup height="32" right="0" bottom="0" left="0">
			<mx:DateField id="dateFieldPomsOfDay" initialize="initDateField(this.dateFieldPomsOfDay)"/>
			<mx:Label text="Days"/>
			<mx:NumericStepper minimum="-365" maximum="365" stepSize="1" id="pomodoroRangeStepper" value="0" width="50" maxChars="4" />
			<s:BitmapImage source="{EmbedImages.ICON_SEARCH}" width="24" height="24"/>
			<fc:AutoComplete
				id="pomodoroFilter"
				dataProvider="{db.datasetStatistics5}"
			   width="132"/>
			<mx:Button id="pomsOfDay" width="32" height="32" icon="{EmbedImages.ICON_REFRESH_CLASS}"
			   click="onPomsOfDayClicked(null)"/>
			<mx:Button width="32" height="32" icon="{EmbedImages.ICON_COPY_CLASS}"
					   click="copyTableToClipboard('Pomodoros', db.pomodorosOfDayDataset.source)"/>
		</s:HGroup>
	</s:Group>

	<!-- day list -->
	<s:Group id="pomodorosPerDayPanel" left="0" top="32" right="0" bottom="0" >
		<s:List id="pomodorosPerDayList"
			dataProvider="{db.pomodorosPerDayDataset}"
			top="0" right="0" bottom="32" left="0"
			contentBackgroundAlpha="0"
			borderVisible="false"
			doubleClickEnabled="true"
			itemRenderer="com.pomodairo.components.PomodoroPerDayRenderer"
			dragMoveEnabled="true" width="100%">
		</s:List>
		<s:HGroup height="32" right="0" bottom="0" left="0">
			<mx:Button id="pomsPerDay"  width="32" height="32" icon="{EmbedImages.ICON_REFRESH_CLASS}"
					   click="onPomsPerDayClicked(null)"/>
			<mx:Button width="32" height="32" icon="{EmbedImages.ICON_COPY_CLASS}"
					   click="copyTableToClipboard('Count', db.pomodorosPerDayDataset.source)"/>
		</s:HGroup>
	</s:Group>

	<!-- week list -->
	<s:Group id="realityFactorPanel" left="0" top="32" right="0" bottom="0">
		<s:List id="realityFactorList"
			dataProvider="{db.realityFactorDataset}"
			top="0" right="0" bottom="32" left="0"
			contentBackgroundAlpha="0"
			borderVisible="false"
			doubleClickEnabled="true"
			itemRenderer="com.pomodairo.components.PomodoroPerWeekRenderer"
			dragMoveEnabled="true" width="100%">
		</s:List>
		<s:HGroup height="32" right="0" bottom="0" left="0">
			<mx:Button id="realityFactor" width="32" height="32" icon="{EmbedImages.ICON_REFRESH_CLASS}"
				click="onRealityFactorsClicked(null)" />
			<mx:Button width="32" height="32" icon="{EmbedImages.ICON_COPY_CLASS}"
				click="copyTableToClipboard('Reality Factors', db.realityFactorDataset.source)" />
		</s:HGroup>
	</s:Group>
</mx:Canvas>
